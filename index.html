
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¯æ—¥ä½“é‡è®°å½•</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f9f9f9; }
    input, button, select { font-size: 1em; margin: 0.5em 0; padding: 0.5em; }
    .record { margin-top: 1em; }
    canvas { max-width: 100%; margin-top: 1em; background: white; border-radius: 10px; box-shadow: 0 0 5px #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f0f0c0; }
    .actions button { margin: 0 2px; }
    .stats { margin-top: 1em; background: #fffbe6; padding: 1em; border-radius: 8px; box-shadow: 0 0 5px #ccc; }
  </style>
</head>
<body>
  <h2>ğŸ“Š æ¯æ—¥ä½“é‡è®°å½•</h2>
  <label for="height">èº«é«˜ (cm): </label>
  <input type="number" id="height" placeholder="å¦‚ï¼š173" />
  <label for="date">é€‰æ‹©æ—¥æœŸ: </label>
  <input type="date" id="date">
  <label for="weight">ä½“é‡ (kg): </label>
  <input type="number" id="weight" step="0.1" placeholder="å¦‚ï¼š83.5">
  <button onclick="addRecord()">ä¿å­˜è®°å½•</button>
  <button onclick="exportCSV()">å¯¼å‡º CSV</button>
  <button onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>

  <canvas id="chart"></canvas>

  <div class="record">
    <h3>ğŸ“… å†å²è®°å½•</h3>
    <table id="history">
      <thead>
        <tr><th>æ—¥æœŸ</th><th>ä½“é‡ (kg)</th><th>å¸‚æ–¤</th><th>BMI</th><th>å˜åŒ– (kg)</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="stats">
    <h3>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h3>
    <p id="summary"></p>
  </div>

<script>
  let records = JSON.parse(localStorage.getItem('weightData') || '[]');
  let height = parseFloat(localStorage.getItem('userHeight') || '0');
  const ctx = document.getElementById('chart').getContext('2d');
  let chart;

  document.getElementById('height').value = height || '';

  document.getElementById('height').addEventListener('change', e => {
    height = parseFloat(e.target.value);
    localStorage.setItem('userHeight', height);
    renderTable();
  });

  function calcBMI(weight) {
    return height > 0 ? (weight / Math.pow(height / 100, 2)).toFixed(1) : '-';
  }

  function renderChart() {
    if (chart) chart.destroy();
    const labels = records.map(r => r.date);
    const data = records.map(r => r.weight);
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'ä½“é‡ (kg)',
          data: data,
          fill: false,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  }

  function renderTable() {
    const tbody = document.querySelector('#history tbody');
    tbody.innerHTML = '';
    records.forEach((r, i) => {
      const delta = i === 0 ? '-' : (r.weight - records[i - 1].weight).toFixed(1);
      const jin = (r.weight * 2).toFixed(1);
      const bmi = calcBMI(r.weight);
      const tr = `<tr>
        <td>${r.date}</td>
        <td>${r.weight}</td>
        <td>${jin}</td>
        <td>${bmi}</td>
        <td>${delta}</td>
        <td class="actions">
          <button onclick="editRecord('${r.date}')">ç¼–è¾‘</button>
          <button onclick="deleteRecord('${r.date}')">åˆ é™¤</button>
        </td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', tr);
    });
    updateStats();
  }

  function updateStats() {
    if (records.length === 0) return document.getElementById('summary').innerText = 'æš‚æ— æ•°æ®';
    const weights = records.map(r => r.weight);
    const min = Math.min(...weights);
    const max = Math.max(...weights);
    const avg = (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1);
    const latest = records[records.length - 1];
    const bmi = calcBMI(latest.weight);
    document.getElementById('summary').innerText = `æœ€ä½ä½“é‡: ${min} kgï¼Œæœ€é«˜ä½“é‡: ${max} kgï¼Œå¹³å‡ä½“é‡: ${avg} kgï¼Œæœ€æ–° BMI: ${bmi}`;
  }

  function addRecord() {
    const w = parseFloat(document.getElementById('weight').value);
    const d = document.getElementById('date').value || new Date().toISOString().split('T')[0];
    if (isNaN(w)) return alert('è¯·è¾“å…¥æœ‰æ•ˆä½“é‡');
    const exist = records.find(r => r.date === d);
    if (exist && !confirm(`${d} å·²ç»è®°å½•è¿‡ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) return;
    if (exist) records = records.filter(r => r.date !== d);
    records.push({ date: d, weight: w });
    records.sort((a, b) => new Date(a.date) - new Date(b.date));
    localStorage.setItem('weightData', JSON.stringify(records));
    renderChart();
    renderTable();
    document.getElementById('weight').value = '';
    document.getElementById('date').value = '';
  }

  function editRecord(date) {
    const record = records.find(r => r.date === date);
    if (record) {
      document.getElementById('date').value = record.date;
      document.getElementById('weight').value = record.weight;
    }
  }

  function deleteRecord(date) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤ ${date} çš„è®°å½•å—ï¼Ÿ`)) {
      records = records.filter(r => r.date !== date);
      localStorage.setItem('weightData', JSON.stringify(records));
      renderChart();
      renderTable();
    }
  }

  function exportCSV() {
    const csv = ['æ—¥æœŸ,ä½“é‡(kg),å¸‚æ–¤,BMI,å˜åŒ–(kg)'];
    records.forEach((r, i) => {
      const delta = i === 0 ? '-' : (r.weight - records[i - 1].weight).toFixed(1);
      const jin = (r.weight * 2).toFixed(1);
      const bmi = calcBMI(r.weight);
      csv.push(`${r.date},${r.weight},${jin},${bmi},${delta}`);
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ä½“é‡è®°å½•.csv';
    a.click();
  }

  function clearAll() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
      localStorage.removeItem('weightData');
      location.reload();
    }
  }

  renderChart();
  renderTable();
</script>
</body>
</html>
