<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥ä½“é‡è®°å½•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f9f9f9; }
    section { background: white; padding: 1em; border-radius: 12px; box-shadow: 0 0 8px rgba(0,0,0,0.05); margin-bottom: 1em; }
    input, button { font-size: 1em; margin: 0.5em 0; padding: 0.5em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0c0; }
  </style>
</head>
<body>
  <section>
    <h2>ğŸ“Š æ¯æ—¥ä½“é‡è®°å½•</h2>
    <label for="height">èº«é«˜ (cm):</label>
    <input type="number" id="height" placeholder="å¦‚ï¼š173">
    <label for="date">é€‰æ‹©æ—¥æœŸ:</label>
    <input type="date" id="date">
    <label for="weight">ä½“é‡ (kg):</label>
    <input type="number" id="weight" step="0.1">
    <button onclick="addRecord()">ä¿å­˜è®°å½•</button>
    <button onclick="exportCSV()">å¯¼å‡º CSV</button>
    <button onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
  </section>

  <section>
    <h3>ğŸ“ˆ ä½“é‡è¶‹åŠ¿å›¾</h3>
    <canvas id="chart"></canvas>
  </section>

  <section>
    <h3>ğŸ“‚ å†å²è®°å½•</h3>
    <table>
      <thead>
        <tr><th>æ—¥æœŸ</th><th>ä½“é‡ (kg)</th><th>å¸‚æ–¤</th><th>BMI</th><th>å˜åŒ–</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
  </section>

  <section>
    <h3>ğŸ“Š ç»Ÿè®¡</h3>
    <p id="summary"></p>
  </section>

<script>
let records = JSON.parse(localStorage.getItem('weightData') || '[]');
let height = parseFloat(localStorage.getItem('userHeight') || '0');
document.getElementById('height').value = height || '';
document.getElementById('height').addEventListener('change', e => {
  height = parseFloat(e.target.value);
  localStorage.setItem('userHeight', height);
  renderTable(); updateStats();
});

function calcBMI(w) {
  return height > 0 ? (w / (height/100)**2).toFixed(1) : '-';
}

function addRecord() {
  const w = parseFloat(document.getElementById('weight').value);
  const d = document.getElementById('date').value || new Date().toISOString().split('T')[0];
  if (isNaN(w)) return alert('è¯·è¾“å…¥ä½“é‡');
  const exist = records.find(r => r.date === d);
  if (exist && !confirm("è¯¥æ—¥æœŸå·²è®°å½•ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ")) return;
  records = records.filter(r => r.date !== d);
  records.push({ date: d, weight: w });
  records.sort((a, b) => new Date(a.date) - new Date(b.date));
  localStorage.setItem('weightData', JSON.stringify(records));
  renderTable(); updateStats(); renderChart();
  document.getElementById('weight').value = '';
  document.getElementById('date').value = '';
}

function deleteRecord(date) {
  if (confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
    records = records.filter(r => r.date !== date);
    localStorage.setItem('weightData', JSON.stringify(records));
    renderTable(); updateStats(); renderChart();
  }
}

function editRecord(date) {
  const r = records.find(r => r.date === date);
  document.getElementById('date').value = r.date;
  document.getElementById('weight').value = r.weight;
}

function renderTable() {
  const tbody = document.getElementById('history');
  tbody.innerHTML = '';
  records.forEach((r, i) => {
    const delta = i === 0 ? '-' : (r.weight - records[i-1].weight).toFixed(1);
    const jin = (r.weight * 2).toFixed(1);
    const bmi = calcBMI(r.weight);
    tbody.innerHTML += `<tr>
      <td>${r.date}</td><td>${r.weight}</td><td>${jin}</td><td>${bmi}</td><td>${delta}</td>
      <td><button onclick="editRecord('${r.date}')">ç¼–è¾‘</button><button onclick="deleteRecord('${r.date}')">åˆ é™¤</button></td>
    </tr>`;
  });
}

function updateStats() {
  if (records.length === 0) return document.getElementById('summary').innerText = 'æš‚æ— æ•°æ®';
  const weights = records.map(r => r.weight);
  const min = Math.min(...weights);
  const max = Math.max(...weights);
  const avg = (weights.reduce((a,b)=>a+b,0)/weights.length).toFixed(1);
  const bmi = calcBMI(records[records.length - 1].weight);
  document.getElementById('summary').innerText = `æœ€ä½: ${min}kgï¼Œæœ€é«˜: ${max}kgï¼Œå¹³å‡: ${avg}kgï¼Œæœ€æ–°BMI: ${bmi}`;
}

function renderChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  if (window.chart) window.chart.destroy();
  window.chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: records.map(r => r.date),
      datasets: [{ label: 'ä½“é‡ (kg)', data: records.map(r => r.weight), borderWidth: 2 }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: false } } }
  });
}

function exportCSV() {
  const csv = ['æ—¥æœŸ,ä½“é‡(kg),å¸‚æ–¤,BMI,å˜åŒ–'];
  records.forEach((r, i) => {
    const delta = i === 0 ? '-' : (r.weight - records[i-1].weight).toFixed(1);
    const jin = (r.weight * 2).toFixed(1);
    const bmi = calcBMI(r.weight);
    csv.push(`${r.date},${r.weight},${jin},${bmi},${delta}`);
  });
  const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'ä½“é‡è®°å½•.csv';
  link.click();
}

function clearAll() {
  if (confirm('ç¡®å®šæ¸…ç©ºï¼Ÿ')) {
    localStorage.removeItem('weightData');
    location.reload();
  }
}

renderTable(); updateStats(); renderChart();
</script>
</body>
</html>
