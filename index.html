<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>每日体重记录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; background: #f9f9f9; }
    section { background: white; padding: 1em; border-radius: 12px; box-shadow: 0 0 8px rgba(0,0,0,0.05); margin-bottom: 1em; }
    input, button { font-size: 1em; margin: 0.5em 0; padding: 0.5em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0c0; }
  </style>
</head>
<body>
  <section>
    <h2>📊 每日体重记录</h2>
    <label for="height">身高 (cm):</label>
    <input type="number" id="height" placeholder="如：173">
    <label for="date">选择日期:</label>
    <input type="date" id="date">
    <label for="weight">体重 (kg):</label>
    <input type="number" id="weight" step="0.1">
    <button onclick="addRecord()">保存记录</button>
    <button onclick="exportCSV()">导出 CSV</button>
    <button onclick="clearAll()">清空所有记录</button>
  </section>

  <section>
    <h3>📈 体重趋势图</h3>
    <canvas id="chart"></canvas>
  </section>

  <section>
    <h3>📂 历史记录</h3>
    <table>
      <thead>
        <tr><th>日期</th><th>体重 (kg)</th><th>市斤</th><th>BMI</th><th>变化</th><th>操作</th></tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
  </section>

  <section>
    <h3>📊 统计</h3>
    <p id="summary"></p>
  </section>

<script>
let records = JSON.parse(localStorage.getItem('weightData') || '[]');
let height = parseFloat(localStorage.getItem('userHeight') || '0');
document.getElementById('height').value = height || '';
document.getElementById('height').addEventListener('change', e => {
  height = parseFloat(e.target.value);
  localStorage.setItem('userHeight', height);
  renderTable(); updateStats();
});

function calcBMI(w) {
  return height > 0 ? (w / (height/100)**2).toFixed(1) : '-';
}

function addRecord() {
  const w = parseFloat(document.getElementById('weight').value);
  const d = document.getElementById('date').value || new Date().toISOString().split('T')[0];
  if (isNaN(w)) return alert('请输入体重');
  const exist = records.find(r => r.date === d);
  if (exist && !confirm("该日期已记录，是否覆盖？")) return;
  records = records.filter(r => r.date !== d);
  records.push({ date: d, weight: w });
  records.sort((a, b) => new Date(a.date) - new Date(b.date));
  localStorage.setItem('weightData', JSON.stringify(records));
  renderTable(); updateStats(); renderChart();
  document.getElementById('weight').value = '';
  document.getElementById('date').value = '';
}

function deleteRecord(date) {
  if (confirm("确定删除？")) {
    records = records.filter(r => r.date !== date);
    localStorage.setItem('weightData', JSON.stringify(records));
    renderTable(); updateStats(); renderChart();
  }
}

function editRecord(date) {
  const r = records.find(r => r.date === date);
  document.getElementById('date').value = r.date;
  document.getElementById('weight').value = r.weight;
}

function renderTable() {
  const tbody = document.getElementById('history');
  tbody.innerHTML = '';
  records.forEach((r, i) => {
    const delta = i === 0 ? '-' : (r.weight - records[i-1].weight).toFixed(1);
    const jin = (r.weight * 2).toFixed(1);
    const bmi = calcBMI(r.weight);
    tbody.innerHTML += `<tr>
      <td>${r.date}</td><td>${r.weight}</td><td>${jin}</td><td>${bmi}</td><td>${delta}</td>
      <td><button onclick="editRecord('${r.date}')">编辑</button><button onclick="deleteRecord('${r.date}')">删除</button></td>
    </tr>`;
  });
}

function updateStats() {
  if (records.length === 0) return document.getElementById('summary').innerText = '暂无数据';
  const weights = records.map(r => r.weight);
  const min = Math.min(...weights);
  const max = Math.max(...weights);
  const avg = (weights.reduce((a,b)=>a+b,0)/weights.length).toFixed(1);
  const bmi = calcBMI(records[records.length - 1].weight);
  document.getElementById('summary').innerText = `最低: ${min}kg，最高: ${max}kg，平均: ${avg}kg，最新BMI: ${bmi}`;
}

function renderChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  if (window.chart) window.chart.destroy();
  window.chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: records.map(r => r.date),
      datasets: [{ label: '体重 (kg)', data: records.map(r => r.weight), borderWidth: 2 }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: false } } }
  });
}

function exportCSV() {
  const csv = ['日期,体重(kg),市斤,BMI,变化'];
  records.forEach((r, i) => {
    const delta = i === 0 ? '-' : (r.weight - records[i-1].weight).toFixed(1);
    const jin = (r.weight * 2).toFixed(1);
    const bmi = calcBMI(r.weight);
    csv.push(`${r.date},${r.weight},${jin},${bmi},${delta}`);
  });
  const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = '体重记录.csv';
  link.click();
}

function clearAll() {
  if (confirm('确定清空？')) {
    localStorage.removeItem('weightData');
    location.reload();
  }
}

renderTable(); updateStats(); renderChart();
</script>
</body>
</html>
